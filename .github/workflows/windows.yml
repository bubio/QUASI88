name: Build and Package (Windows)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, ARM64]

    steps:
    - uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Install SDL2
      run: |
        vcpkg install sdl2:${{ matrix.arch }}-windows

    - name: Configure CMake
      run: |
        cmake -B build -A ${{ matrix.arch }} `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"

    - name: Build
      run: cmake --build build --config Release

    - name: Package (ZIP for fallback)
      run: |
        cd build
        cpack -C Release -G ZIP

    # MSIX packaging requires more setup (manifest, assets, certificates)
    # Here we show the steps to prepare the layout and package it.
    # Note: In a real scenario, you'd need a valid certificate to sign the MSIX.
    - name: Prepare MSIX Layout
      run: |
        mkdir msix_layout
        cp build/bin/Release/quasi88.exe msix_layout/
        cp keyconf.rc msix_layout/
        cp quasi88.rc msix_layout/
        cp touchkey.rc msix_layout/
        # Here you would add AppxManifest.xml and assets
        # For now, we'll just upload the build dir as artifact
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: QUASI88-Windows-${{ matrix.arch }}
        path: build/*.zip
