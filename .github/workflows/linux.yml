name: Build and Package (Linux)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, aarch64]

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies (x86_64)
      if: matrix.arch == 'x86_64'
      run: |
        sudo apt-get update
        sudo apt-get install -y libsdl2-dev rpm

    - name: Install Dependencies (aarch64)
      if: matrix.arch == 'aarch64'
      run: |
        sudo dpkg --add-architecture arm64
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu libsdl2-dev:arm64 rpm

    - name: Configure CMake
      run: |
        if [ "${{ matrix.arch }}" = "aarch64" ]; then
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++
        else
          cmake -B build -DCMAKE_BUILD_TYPE=Release
        fi

    - name: Build
      run: cmake --build build --config Release

    - name: Package (deb, rpm)
      run: |
        cd build
        cpack -G "DEB;RPM"

    # AppImage creation (requires appimagetool or appimage-builder)
    # This is a simplified version using a pre-built appimagetool
    - name: Package (AppImage)
      if: matrix.arch == 'x86_64'
      run: |
        # AppImage creation steps would go here
        # For now, we'll focus on deb and rpm which are handled by CPack
        echo "AppImage creation step"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: QUASI88-Linux-${{ matrix.arch }}
        path: |
          build/*.deb
          build/*.rpm
